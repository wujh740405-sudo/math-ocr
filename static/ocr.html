<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI æ•°å­¦è€å¸ˆï¼ˆå›¾ç‰‡ OCR + è‡ªåŠ¨è®²è§£ï¼‰</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, { delimiters: [{left:'$$',right:'$$',display:true},{left:'\\[',right:'\\]',display:true},{left:'$',right:'$',display:false},{left:'\\(',right:'\\)',display:false}] });"></script>

  <style>
    body{font-family: "Microsoft YaHei",sans-serif;background:#f3f4f6;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
    h1{color:#1e3a8a}
    #container{width:100%;max-width:900px}
    #chat-box{background:#fff;border-radius:12px;padding:16px;height:50vh;overflow:auto;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .msg{padding:10px 14px;border-radius:10px;margin:8px 0;max-width:85%;white-space:pre-wrap}
    .user{align-self:flex-end;background:#2563eb;color:#fff;margin-left:auto;border-bottom-right-radius:0}
    .bot{align-self:flex-start;background:#f3f4f6;color:#111;border-bottom-left-radius:0}
    #controls{display:flex;gap:8px;margin-top:12px;align-items:flex-start}
    textarea{flex:1;height:70px;border-radius:8px;padding:10px;border:1px solid #ddd;resize:none}
    button{padding:10px 14px;border-radius:8px;border:0;background:#2563eb;color:#fff;cursor:pointer}
    input[type=file]{display:none}
    .small{font-size:13px;color:#666;margin-top:6px}
    .ocr-block{background:#fff;border-radius:8px;padding:10px;margin-top:10px;border:1px solid #eee}
    .progress{font-size:13px;color:#999}
  </style>
</head>
<body>
  <div id="container">
    <h1>ğŸ¤– AI æ•°å­¦è€å¸ˆï¼ˆæ”¯æŒå›¾ç‰‡è¯†åˆ«ï¼‰</h1>

    <div id="chat-box">
      <div class="msg bot">ä½ å¥½ï¼Œæˆ‘æ˜¯ AI æ•°å­¦è€å¸ˆï¼Œå¯ä»¥è¯†åˆ«é¢˜ç›®å›¾ç‰‡å¹¶ç”Ÿæˆåˆ†æ­¥è®²è§£ã€‚è¯•è¯•ä¸Šä¼ ä¸€å¼ é¢˜ç›®ç…§ç‰‡å§ã€‚</div>
    </div>

    <div id="controls">
      <textarea id="text-input" placeholder="ä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥é¢˜ç›®ï¼Œä¾‹å¦‚ï¼šå·²çŸ¥ f(x)=x^2-3x+2ï¼Œæ±‚å•è°ƒåŒºé—´"></textarea>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button id="send-text">å‘é€æ–‡æœ¬</button>
        <label style="display:inline-block">
          <input id="file-input" type="file" accept="image/*" />
          <button id="choose-file">ä¸Šä¼ å›¾ç‰‡</button>
        </label>
        <button id="camera-btn">æ‹ç…§ï¼ˆç§»åŠ¨ç«¯ï¼‰</button>
      </div>
    </div>

    <div class="small">æç¤ºï¼šå»ºè®®æ‹ç…§ä½¿é¢˜ç›®æ¸…æ™°ä¸”å…‰çº¿å‡åŒ€ã€‚è‹¥é¢˜ä¸ºæ‰‹å†™æˆ–å¤æ‚å…¬å¼ï¼Œå»ºè®®ä½¿ç”¨å•†ç”¨ OCRï¼ˆMathpixï¼‰ã€‚</div>
    <div id="ocr-area"></div>
  </div>

<script>
/* ========== é…ç½®åŒº ========== */
const API_BASE = "https://math-agent-proxy.onrender.com"; // <- æ›¿æ¢ä¸ºä½ çš„ Render åŸŸå
const PROXY_KEY = "mysecret123"; // <- å¦‚æœä½ åœ¨æœåŠ¡ç«¯è®¾ç½®äº† PROXY_KEYï¼Œè¯·ä¿æŒä¸€è‡´
const MAX_UPLOAD_MB = 4; // å®¢æˆ·ç«¯é™åˆ¶æ–‡ä»¶å¤§å°
/* ============================ */

const chatBox = document.getElementById('chat-box');
const textInput = document.getElementById('text-input');
const sendTextBtn = document.getElementById('send-text');
const fileInput = document.getElementById('file-input');
const chooseFileBtn = document.getElementById('choose-file');
const cameraBtn = document.getElementById('camera-btn');
const ocrArea = document.getElementById('ocr-area');

function addMessage(html, cls='bot') {
  const el = document.createElement('div');
  el.className = 'msg ' + cls;
  el.innerHTML = html;
  chatBox.appendChild(el);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// ç®€æ´æ¸…ç†å‡½æ•°ï¼ˆå¯æŒ‰éœ€å¢å¼ºï¼‰
function cleanServerText(t){
  return t.replace(/\r\n/g,'\n').replace(/\n{2,}/g,'\n\n').trim();
}

/* ========== æ–‡æœ¬å‘é€ ========== */
sendTextBtn.addEventListener('click', async ()=>{
  const q = textInput.value.trim();
  if(!q) return;
  addMessage(`<strong>ä½ ï¼š</strong><br>${q}`, 'user');
  textInput.value='';
  addMessage('<em>AI æ­£åœ¨æ€è€ƒä¸­â€¦â€¦</em>', 'bot');
  try {
    const resp = await fetch(API_BASE + '/call_deepseek', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-PROXY-KEY': PROXY_KEY
      },
      body: JSON.stringify({ query: q })
    });
    const j = await resp.json();
    // DeepSeek è¿”å›è·¯å¾„å¯èƒ½ä¸åŒï¼Œä»¥ä¸‹æ˜¯å¸¸è§ç»“æ„ï¼š
    const ans = j.choices?.[0]?.message?.content || JSON.stringify(j, null, 2);
    addMessage(`<strong>AIï¼š</strong><br>${escapeHtml(cleanServerText(ans))}`, 'bot');
    // æ¸²æŸ“å…¬å¼
    if(window.renderMathInElement) renderMathInElement(chatBox);
  } catch(e){
    addMessage('âŒ è¯·æ±‚å¤±è´¥ï¼š'+ e.message, 'bot');
  }
});

/* ========== æ–‡ä»¶ä¸Šä¼ ï¼ˆå«å®¢æˆ·ç«¯å‹ç¼©ï¼‰ ========== */
// æŠŠ File å¯¹è±¡å‹ç¼©åˆ°æŒ‡å®šåƒç´ å®½åº¦ï¼ˆä¿æŒå›¾ç‰‡æ¸…æ™°åº¦åŒæ—¶å‡å°ä½“ç§¯ï¼‰
function resizeImage(file, maxWidth=1200) {
  return new Promise((resolve, reject)=>{
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e=>{
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        const scale = Math.min(1, maxWidth / img.width);
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob=>{
          resolve(blob);
        }, 'image/jpeg', 0.85);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function uploadAndSolve(file) {
  if(!file) return;
  if(file.size > MAX_UPLOAD_MB * 1024 * 1024) {
    addMessage('âš ï¸ æ–‡ä»¶å¤ªå¤§ï¼Œè¯·å‹ç¼©æˆ–é€‰å°å›¾ï¼ˆå»ºè®® < '+MAX_UPLOAD_MB+'MBï¼‰', 'bot');
    return;
  }

  addMessage(`<strong>ä½ ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡</strong>`, 'user');
  const loading = document.createElement('div'); loading.className='msg bot typing'; loading.innerText='å›¾ç‰‡ä¸Šä¼ å¹¶è¯†åˆ«ä¸­â€¦â€¦';
  chatBox.appendChild(loading); chatBox.scrollTop = chatBox.scrollHeight;

  try {
    // å®¢æˆ·ç«¯å‹ç¼©ï¼ˆå¯é€‰ï¼‰
    const blob = await resizeImage(file, 1200);

    const fd = new FormData();
    fd.append('image', blob, file.name);

    const resp = await fetch(API_BASE + '/ocr_and_solve', {
      method:'POST',
      body: fd,
      headers: {
        'X-PROXY-KEY': PROXY_KEY
      }
    });
    const j = await resp.json();
    loading.remove();

    // j åº”åŒ…å« { ocr: {...}, deepseek: {...} }
    const ocr = j.ocr || {};
    const deep = j.deepseek || j.deepseek || null;

    // å±•ç¤º OCR æ–‡æœ¬ä¸ LaTeXï¼ˆè‹¥æœ‰ï¼‰
    let ocrHtml = `<div class="ocr-block"><strong>OCR è¯†åˆ«ï¼ˆçº¯æ–‡æœ¬ï¼‰ï¼š</strong><pre>${escapeHtml(ocr.text||ocr.plain||'æ— ')}</pre>`;
    if(ocr.latex) ocrHtml += `<strong>OCR è¯†åˆ«ï¼ˆLaTeXï¼‰ï¼š</strong><pre>${escapeHtml(ocr.latex)}</pre>`;
    ocrHtml += `</div>`;
    addMessage(ocrHtml, 'bot');

    // å±•ç¤º DeepSeek ç»“æœ
    const ans = deep?.choices?.[0]?.message?.content || JSON.stringify(deep || j, null, 2);
    addMessage(`<strong>AI è®²è§£ï¼š</strong><br>${escapeHtml(cleanServerText(ans))}`, 'bot');

    // æ¸²æŸ“ KaTeX
    if(window.renderMathInElement) renderMathInElement(chatBox);
  } catch (e) {
    loading.remove();
    addMessage('âŒ OCR æˆ– æ±‚è§£ å¤±è´¥ï¼š'+ e.message, 'bot');
  }
}

// å¤„ç†æ–‡ä»¶é€‰æ‹©
fileInput.addEventListener('change', ()=> {
  const f = fileInput.files[0];
  if(!f) return;
  uploadAndSolve(f);
});

// ç»‘å®šâ€œä¸Šä¼ â€æŒ‰é’®åœ¨æŸäº›æµè§ˆå™¨ä¸­è§¦å‘æ–‡ä»¶é€‰æ‹©
chooseFileBtn.addEventListener('click', ()=> fileInput.click());

/* ========== ç§»åŠ¨ç«¯æ‹ç…§ï¼ˆç®€æ˜“ï¼‰ ========== */
cameraBtn.addEventListener('click', ()=> {
  // åœ¨ç§»åŠ¨ç«¯å¯ç›´æ¥è§¦å‘ file inputï¼ŒæŸäº›æ‰‹æœºä¼šæ‰“å¼€ç›¸æœº
  fileInput.setAttribute('accept','image/*;capture=camera');
  fileInput.click();
});

// === å·¥å…·å‡½æ•° ===
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
}
</script>
</body>
</html>
